## 基本概念

数据仓库：一个数据管理系统，管理从业务系统采集到的数据，分析计算之后为下游业务提供数据支撑

建模的目的：让数据形式更适合计算分析

建模：将数据有序的组织存储起来，模型指建模的规则

维度建模缺点：维度表会有冗余，增加存储空间，

维度建模优点：完成需求分析更快

​						能较好的实现大规模复杂查询

**hive on spark :** hive 将HQL 解析成Spark作业，最后由Spark完成

**Spark on hive :** 通过Spark SQL使用Hive的语句来操作hive表，底层执行还是Spark RDD

维度模型分层规划

![uTools_1654612737948](F:\Atguigu\04_Note\文档\MDpng\uTools_1654612737948.png)



数据仓库构建流程

![image-20220607224159175](F:\Atguigu\04_Note\文档\MDpng\image-20220607224159175.png)

## 维度模型

### 设计事实表

事实表组成：维度表外键和业务过程的度量（可累加的数字类型字段）

**事务型事实表**：它保存的是各业务过程的原子操作事件，即最细粒度的操作事件。粒度是指事实表中一行数据所表达的业务细节程度。

​		设计流程：选择业务过程→声明粒度→确认维度→确认事实

**周期型快照事实表：**按照规律或者可预见的时间记录数据可用周期快照事实表，主要用于存量型和状态型指标

​		设计流程：确认粒度 --> 确认事实

​		事务型事实表都是可加事实，周期型事实表都是半可加事实

**累积型快照事实表：**一个业务流程中有多个业务过程可用（多事务关联统计），累积型快照事实表通常具有多个日期字段，每个日期对应业务流程中的一个关键业务过程（里程碑）

​		 设计流程：选择业务过程→声明粒度→确认维度→确认事实

### 设计维度表

设计流程：确认维度表→确认主维表和相关维表→确认维度属性

**每日全量快照表：**一般使用每日全量快照表，用日期做分区字段

把维度属性直接加到相关的事实表中叫**维度退化**，维度退化会造成**数据冗余**

维度最细或与维度属性最相关的就是**主维表**，其余为相关维表，维度表的粒度通常和主维表相同

**拉链表：**记录每条数据的生命周期，生命周期结束，就会开始新的一条记录；

​				适用于数据变化频率不高，变化缓慢的数据

​				用法：**生效开始日期<=目标日期  且  生效结束日期>= 目标日期**

​				意义：能够更加高效的保存维度信息的历史状态 

**汇总表**：按业务过程相同，统计周期相同，统计粒度相同的指标创建汇总表

汇总表与事实表是一对一的关系，事实表与汇总表是一对多或一对一的关系

表的字段由JSON字符串的一级字段确定

hive 中 textfile格式的表可以直接导入gzip或Bzip2格式的文件，hive默认的建表格式就是textfile

## 设计要点

#### 设计要点之各层存储格式

​		ODS层数据较多，因此采用**textfile**格式和压缩比较高的**gzip**压缩格式

​		DIM，DWD层采用**orc**列式存储加**snappy**压缩

#### 设计要点之ODS层表结构设计思路

​		**1.用户行为日志数据**一般为JSON格式，所以表结构沿用JSON文件结构的第一层级字段，嵌套层级使用复杂数据结构承载（array，map，stract），用（ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'）加载数据

​		**2.业务数据**

​			全量表一般是从MySQL用Datax同步过来的tsv格式数据，各字段数据间用制表符间隔，可直接使用（ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'） 加载数据

​			 增量表全量一般是从MySQL用Maxwell同步过来的JSON格式数据，用（ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'）加载数据

**使用事务型事实表的设计过程设计业务总线矩阵**（选择业务过程→声明粒度→确认维度→确认事实）

DataX做全量同步，Maxwell做全量同步，基于查询，无法获取中间状态

Maxwell做增量同步，基于binlog，可以获取中间状态

事实表度量值不能为空

#### 设计要点之DWD层表结构设计思路

事务型事实表设计思路：根据业务总线矩阵确认业务过程，确认最细粒度，确认维度，确认度量

建表字段一般有：

​					表自己的编号id，

​					用来与维度表关联用的维度外键，

​					业务所需的数据来源表的一些字段，

​					业务度量值，

​					数据来源（来源编号,来源类型编码,来源类型名称等）（可选）

数据装载考虑数据从哪来到哪去



|      类型      |     分区规划     |   同步类型   |
| :------------: | :--------------: | :----------: |
|   事务事实表   |   每日增量分区   | 每日增量同步 |
| 周期快照事实表 |   每日全量分区   | 每日全量同步 |
| 累积快照事实表 | 按照数据状态分区 | 每日增量同步 |



#### 设计要点之DWS层设计原则

​		汇总表不能有去重计算的指标，可以留下相关信息计算用户指标时计算

​		汇总表的设计应尽可能支持更多的指标，以减少重复计算，提高性能

date_add(锚点日期，往前推的日期数-1)

#### 指标体系：

原子指标：基于某一业务过程的度量值

派生指标：基于原子指标

​				**派生指标 = 原子指标 + 统计周期 + 业务限定 + 统计粒度**



lead(field, num, defaultvalue) field 需要查找的字段，num 往后查找的 num 行的数据，defaultvalue 没有符合条件的默认值











